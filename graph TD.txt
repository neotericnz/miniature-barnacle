graph TD
    %% Define Groups
    subgraph Azure
        subgraph Networking
            AKS[Immuta Application (AKS)]
            PostgreSQL[Metadata Database (PostgreSQL)]
            Elasticsearch[Elasticsearch (ISV)]
            Blob[Blob Storage]
            NSGs[Network Security Groups]
        end
        
        subgraph Security
            AAD[Azure AD]
            KeyVault[Azure Key Vault]
            WAF[App Gateway with WAF]
        end
        
        subgraph Monitoring
            Monitor[Azure Monitor]
            Defender[Microsoft Defender]
        end
    end

    subgraph Snowflake and Users
        Snowflake[Snowflake]
        DataConsumers[Data Consumers]
    end

    ImmutaAdmins[Immuta Admins]

    %% Define Connections
    AAD --> ImmutaAdmins : "Authenticates"
    AAD --> DataConsumers : "Authenticates"
    ImmutaAdmins --> AKS : "Manage Policies"

    AAD --> AKS : "Authenticates"
    KeyVault --> AKS : "Secures Secrets"
    WAF --> AKS : "Routes Secure Traffic"

    AKS --> PostgreSQL : "Policy Queries"
    AKS --> Elasticsearch : "Metadata Indexing"
    AKS --> Blob : "Stores Configurations"
    AKS --> Snowflake : "Applies Policies"
    Snowflake --> DataConsumers : "Access Datasets"

    Monitor --> AKS : "Collects Logs"
    Monitor --> Defender : "Analyzes Threats"
    NSGs --> Blob : "Restricts Traffic"
    NSGs --> Snowflake : "Restricts Access"
