graph TD
    %% Title %%
    A[Immuta Platform on Azure - Deployment Diagram with Microsoft Defender]

    %% Azure Nodes %%
    subgraph Azure
        subgraph Networking
            VNet1[Immuta VNet]
            AKS[Immuta Application AKS]
            PostgreSQL[Metadata Database PostgreSQL]
            Elastic[Elasticsearch ISV]

            VNet2[Shared Services VNet]
            Blob[Blob Storage]
            NSG[Network Security Groups NSGs]
        end

        subgraph Security
            AAD[Azure AD]
            KeyVault[Key Vault]
            WAF[App Gateway with WAF]
        end

        subgraph Monitoring_and_Threat_Protection
            Monitor[Azure Monitor]
            Defender[Microsoft Defender]
        end
    end

    %% Snowflake and Users %%
    subgraph Snowflake_and_Data_Consumers
        Snowflake[Snowflake]
        DataConsumers[Data Consumers]
    end

    ImmutaAdmins[Immuta Admins]

    %% Relationships %%
    AAD --> ImmutaAdmins
    AAD --> DataConsumers
    ImmutaAdmins --> AKS
    AAD --> AKS
    KeyVault --> AKS
    WAF --> AKS

    AKS --> PostgreSQL
    AKS --> Elastic
    AKS --> Blob
    AKS --> Snowflake
    Snowflake --> DataConsumers

    Monitor --> AKS
    Monitor --> Defender
    NSG --> Blob
